<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDEA</title>
    <link rel="stylesheet" href="styles.css">
    <link href="prism.css" rel="stylesheet" />  <!-- Prism for code syntax highlighting -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> <!-- Mic icon -->
</head>
<body class="main-app">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1>IDEA</h1>
                <span class="navbar-subtitle">Intelligent Data Exploring Assistant</span>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="navbar-menu">
                <button id="systemPromptButton" class="nav-btn">
                    <span class="material-icons">settings</span>
                    System Prompt
                </button>
                <button id="knowledgeBaseButton" class="nav-btn">
                    <span class="material-icons">psychology</span>
                    Knowledge Base
                </button>
                <button id="downloadButton" class="nav-btn">
                    <span class="material-icons">download</span>
                    Download
                </button>
                <button id="conversationsButton" class="nav-btn">
                    <span class="material-icons">chat</span>
                    Conversations
                </button>
                <button id="newMessagesButton" class="nav-btn">
                    <span class="material-icons">refresh</span>
                    Start Over
                </button>
                <button id="accountSettingsButton" class="nav-btn">
                    <span class="material-icons">manage_accounts</span>
                    Account
                </button>
                <button id="logoutButton" class="nav-btn logout-btn">
                    <span class="material-icons">logout</span>
                    Logout
                </button>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="navbar-toggle" id="navbarToggle">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
        
        <!-- Mobile Navigation Menu -->
        <div class="navbar-mobile-menu" id="navbarMobileMenu">
            <button id="systemPromptButtonMobile" class="nav-btn-mobile">
                <span class="material-icons">settings</span>
                System Prompt
            </button>
            <button id="knowledgeBaseButtonMobile" class="nav-btn-mobile">
                <span class="material-icons">psychology</span>
                Knowledge Base
            </button>
            <button id="downloadButtonMobile" class="nav-btn-mobile">
                <span class="material-icons">download</span>
                Download conversation
            </button>
            <button id="conversationsButtonMobile" class="nav-btn-mobile">
                <span class="material-icons">chat</span>
                Conversations
            </button>
            <button id="newMessagesButtonMobile" class="nav-btn-mobile">
                <span class="material-icons">refresh</span>
                Start over
            </button>
            <button id="accountSettingsButtonMobile" class="nav-btn-mobile">
                <span class="material-icons">manage_accounts</span>
                Account Settings
            </button>
            <button id="logoutButtonMobile" class="nav-btn-mobile logout-btn">
                <span class="material-icons">logout</span>
                Logout
            </button>
        </div>
    </nav>

    <!-- Mobile overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Knowledge Base Management Modal -->
    <div id="knowledgeBaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Knowledge Base Management</h2>
                <span class="close" id="closeKnowledgeBaseModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="knowledge-base-container">
                    <!-- Upload Section -->
                    <div class="upload-section">
                        <div class="section-header">
                            <h3>Upload New Papers</h3>
                            <div class="upload-info">
                                <span>Supported formats: PDF, TXT, DOC, DOCX, MD</span>
                                <span>Max size: 50MB</span>
                            </div>
                        </div>
                        <div class="upload-area" id="knowledgeBaseUploadArea">
                            <div class="upload-content">
                                <span class="material-icons upload-icon">cloud_upload</span>
                                <p>Drag and drop files here or click to browse</p>
                                <input type="file" id="knowledgeBaseFileInput" multiple accept=".pdf,.txt,.doc,.docx,.md" style="display: none">
                                <button id="browseKnowledgeBaseFiles" class="btn btn-primary">Browse Files</button>
                            </div>
                        </div>
                        <div id="knowledgeBaseUploadProgress" class="progress-bar" style="display: none">
                            <div class="progress"></div>
                        </div>
                    </div>

                    <!-- Papers List Section -->
                    <div class="papers-list-section">
                        <div class="section-header">
                            <h3>Current Papers</h3>
                            <div class="knowledge-base-stats" id="knowledgeBaseStats">
                                <span id="totalFiles">0 files</span>
                                <span id="totalSize">0 MB</span>
                            </div>
                        </div>
                        <div id="papersList" class="papers-list">
                            <div class="loading">Loading papers...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Prompt Management Modal -->
    <div id="promptManagementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>System Prompt Management</h2>
                <span class="close" id="closePromptModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="prompt-management-container">
                    <!-- Prompt List Section -->
                    <div class="prompt-list-section">
                        <div class="section-header">
                            <h3>Available Prompts</h3>
                            <button id="createNewPromptBtn" class="btn btn-primary">
                                <span class="material-icons">add</span>
                                Create New
                            </button>
                        </div>
                        <div id="promptsList" class="prompts-list">
                            <!-- Prompts will be dynamically loaded here -->
                        </div>
                    </div>

                    <!-- Prompt Editor Section -->
                    <div class="prompt-editor-section">
                        <div id="promptEditor" class="prompt-editor" style="display: none;">
                            <h3 id="editorTitle">Edit Prompt</h3>
                            <form id="promptForm">
                                <div class="form-group">
                                    <label for="promptName">Name:</label>
                                    <input type="text" id="promptName" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="promptDescription">Description:</label>
                                    <input type="text" id="promptDescription" name="description">
                                </div>
                                <div class="form-group">
                                    <label for="promptContent">Content:</label>
                                    <textarea id="promptContent" name="content" required rows="20"></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" id="savePromptBtn" class="btn btn-success">Save</button>
                                    <button type="button" id="cancelEditBtn" class="btn btn-secondary">Cancel</button>
                                </div>
                            </form>
                        </div>
                        <div id="promptPreview" class="prompt-preview">
                            <h3>Select a prompt to view or edit</h3>
                            <p>Choose a prompt from the list on the left to view its content or make changes.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="accountSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Account Settings</h2>
                <span class="close" id="closeAccountSettingsModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="accountSettingsForm">
                    <div class="form-group">
                        <label for="currentPasswordInput">Current Password</label>
                        <input type="password" id="currentPasswordInput" autocomplete="current-password" required>
                    </div>
                    <div class="form-group">
                        <label for="newPasswordInput">New Password</label>
                        <input type="password" id="newPasswordInput" autocomplete="new-password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPasswordInput">Confirm New Password</label>
                        <input type="password" id="confirmPasswordInput" autocomplete="new-password" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Update Password</button>
                        <button type="button" id="cancelAccountSettingsBtn" class="btn btn-secondary">Cancel</button>
                    </div>
                    <div id="accountSettingsMessage" class="form-message" aria-live="polite"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Conversations Management Modal -->
    <div id="conversationsModal" class="modal">
        <div class="modal-content wide-modal">
            <div class="modal-header">
                <h2>Conversation History</h2>
                <span class="close" id="closeConversationsModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="conversations-container">
                    <!-- Search and Filter Section -->
                    <div class="conversations-header">
                        <div class="search-section">
                            <input type="text" id="conversationSearch" placeholder="Search conversations..." class="search-input">
                            <button id="refreshConversations" class="btn btn-secondary">
                                <span class="material-icons">refresh</span>
                                Refresh
                            </button>
                        </div>
                        <div class="filter-section">
                            <button id="showAllConversations" class="btn btn-primary active">All</button>
                            <button id="showFavoriteConversations" class="btn btn-secondary">Favorites</button>
                        </div>
                    </div>
                    
                    <!-- Conversations List -->
                    <div class="conversations-list" id="conversationsList">
                        <div class="loading">Loading conversations...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div id="chatDisplay" class="chat-display"></div>
        <footer class="chat-footer">
            <div class="file-upload-section">
                <input type="file" id="fileUpload" multiple accept=".csv,.txt,.json,.nc,.xlsx, .jpg, .png, .pdf" style="display: none">
                <div id="uploadProgress" class="progress-bar" style="display: none">
                    <div class="progress"></div>
                </div>
                <div id="uploadedFiles" class="uploaded-files-list"></div>
            </div>
            <div class="input-container">
                <button id="uploadButton" title="Max file size: 10MB">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21.44 11.05l-9.19 9.19a6.003 6.003 0 01-8.49-8.49l9.19-9.19a4.002 4.002 0 015.66 5.66l-9.2 9.19a2.001 2.001 0 01-2.83-2.83l8.49-8.48" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                
                <textarea id="messageInput" placeholder="Type your message, click mic to dictate, or attach/drop a file..." autocomplete="off" rows="1"></textarea>

                <button id="micButton" title="Dictate" class="icon-button">
                    <i class="material-icons">mic</i>
                </button>

                <!-- Drop overlay -->
                <div id="dropOverlay" class="drop-overlay">
                    <p>Drop files or screenshots here</p>
                </div>
            </div>
            <button id="sendButton">Send</button>
            <button id="stopButton" disabled>Stop</button>
            <input type="file" id="fileUpload" multiple style="display: none">
        </footer>

        <div id="promptIdeasContainer"></div>
    </div>
    <div class="disclaimer-text">
        <span>IDEA can make mistakes — check important results. Inputs may be used to improve services by UHSLC and/or LLM providers.</span>
        <a href="https://github.com/uhsealevelcenter/IDEA"> [More info]</a>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify for sanitizing HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js" integrity="sha512-jB0TkTBeQC9ZSkBqDhdmfTv1qdfbWpGE72yJ/01Srq6hEzZIz2xkz1e57p9ai7IeHMwEG7HpzG6NdptChif5Pg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="prism.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
        },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script src="config.js"></script>
    <script src="conversation_manager.js"></script>
    <script src="assistant.js"></script>
    <script src="account-settings.js"></script>
    <script src="prompt-manager.js"></script>
    <script src="knowledge-base.js"></script>
    <script src="conversation_ui.js"></script>
</body>
</html>
